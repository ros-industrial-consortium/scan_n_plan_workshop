<?xml version="1.0"?>
<launch>
  <arg name="sim_vision" default="True"/>
  <arg name="sim_robot" default="True"/>
  <arg name="bypass_execution" default="$(var sim_robot)" />
  <arg name="scan_from_file" default="False"/>
  <arg name="mesh_file" default="$(find-pkg-share snp_automate_2022)/meshes/part_scan.ply"/>
  <arg name="scan_trajectory_file" default="$(find-pkg-share snp_automate_2022)/config/scan_traj.yaml"/>
  <arg name="verbose" default="True"/>
  <arg name="touch_links" default="[table, base_link, floor]"/>
  <arg name="robot_description_file" default="$(find-pkg-share snp_automate_2022)/urdf/workcell.xacro"/>
  <arg name="robot_description" default="$(command 'xacro $(var robot_description_file) ros_distro:=$(env ROS_DISTRO)')"/>
  <arg name="robot_description_semantic" default="$(command 'cat $(find-pkg-share snp_automate_2022)/config/workcell.srdf')"/>
  <arg name="reference_frame" default="base_link"/>
  <!-- Set the default name of the follow joint trajectory action depending on whether the robot is simulated (i.e., ros2_control) or real hardware is being used -->
  <arg name="follow_joint_trajectory_action" default="joint_trajectory_position_controller/follow_joint_trajectory" if="$(var sim_robot)"/>
  <arg name="follow_joint_trajectory_action" default="joint_trajectory_action" unless="$(var sim_robot)"/>

  <!-- URDF, Rviz -->
  <include file="$(find-pkg-share snp_automate_2022)/launch/test.launch.xml">
    <arg name="robot_description" value="$(var robot_description)"/>
    <arg name="robot_description_semantic" value="$(var robot_description_semantic)"/>
    <arg name="rviz" value="False"/>
    <arg name="use_gui" value="$(var bypass_execution)"/>
  </include>

  <node pkg="rviz2" exec="rviz2" args="-d $(find-pkg-share snp_automate_2022)/config/app.rviz">
    <param name="mesh_file" value="/tmp/results_mesh.ply"/>
    <param name="motion_group" value="manipulator"/>
    <param name="reference_frame" value="$(var reference_frame)"/>
    <param name="tcp_frame" value="sand_tcp"/>
    <param name="camera_frame" value="camera_color_optical_frame"/>
    <param name="robot_description" value="$(var robot_description)"/>
    <param name="robot_description_semantic" value="$(var robot_description_semantic)"/>
    <!-- TSDF parameters -->
    <param name="tsdf.min.x" value="0.21"/>
    <param name="tsdf.min.y" value="-0.45"/>
    <param name="tsdf.min.z" value="0.112"/>
    <param name="tsdf.max.x" value="1.51"/>
    <param name="tsdf.max.y" value="0.45"/>
    <param name="tsdf.max.z" value="0.527"/>
    <param name="tsdf.voxel_length" value="0.01"/>
    <param name="tsdf.sdf_trunc" value="0.03"/>
    <param name="rgbd.depth_scale" value="1000.0"/>
    <param name="rgbd.depth_trunc" value="1.1"/>
  </node>

  <!-- Launch Calibration Node and Mutable Transform Publisher Node  -->
  <!--<include file="$(find-pkg-share r2_apps)/launch/hand_eye_launch.py"/>-->
$(var follow_joint_trajectory_action)
  <!-- Launch Open3d Interface Node -->
  <group unless="$(var sim_vision)">
    <node pkg="industrial_reconstruction" exec="industrial_reconstruction">
      <param name="depth_image_topic" value="/camera/aligned_depth_to_color/image_raw"/>
      <param name="color_image_topic" value="/camera/color/image_raw"/>
      <param name="camera_info_topic" value="/camera/color/camera_info"/>
      <param name="cache_count" value="1"/>
      <param name="slop" value="0.05"/>
    </node>
    <include file="$(find-pkg-share realsense2_camera)/launch/rs_launch.py">
      <arg name="align_depth" value="true"/>
      <arg name="enable_pointcloud" value="true"/>
      <arg name="color_width" value="640"/>
      <arg name="color_height" value="360"/>
      <arg name="color_fps" value="90.0"/>
    </include>
  </group>

  <group if="$(var sim_vision)">
    <node pkg="snp_scanning" exec="reconstruction_sim_node">
      <param name="mesh_file" value="$(var mesh_file)"/>
      <param name="reference_frame" value="$(var reference_frame)"/>
      <remap from="mesh" to="industrial_reconstruction_mesh"/>
    </node>
  </group>

  <!-- Launch Toolpath Planning Node -->
  <node pkg="snp_tpp" exec="snp_tpp_app">
    <param name="config_file" value="$(find-pkg-share snp_automate_2022)/config/tpp.yaml"/>
  </node>

  <!-- Launch Scanning Node -->
  <group if="$(var scan_from_file)">
    <node pkg="snp_scanning" exec="scan_motion_plan_from_file_node">
      <param name="scan_trajectory_file" value="$(var scan_trajectory_file)"/>
    </node>
  </group>

  <group unless="$(var scan_from_file)">
    <node pkg="snp_scanning" exec="scan_trajectory_node" output="screen">
      <param name="target_frame" value="scan_frame"/>
      <param name="base_frame" value="base_link"/>
      <param name="plane_length" value="0.5"/>
      <param name="plane_width" value="0.3"/>
      <param name="x_spacing" value="0.1"/>
      <param name="y_spacing" value="0.1"/>
      <param name="height_offset" value="0.5"/>
      <param name="motion_group" value="manipulator"/>
      <param name="reference_frame" value="camera_color_optical_frame"/>
      <param name="tcp_frame" value="sand_tcp"/>
    </node>
  </group>

  <!-- Launch Motion Planning Node -->
  <include file="$(find-pkg-share snp_motion_planning)/launch/planning_server.launch.xml">
    <arg name="robot_description" value="$(var robot_description)"/>
    <arg name="robot_description_semantic" value="$(var robot_description_semantic)"/>
    <arg name="verbose" value="$(var verbose)"/>
    <arg name="touch_links" value="$(var touch_links)"/>
  </include>

  <!-- Launch Motion Execution Node -->
  <node pkg="snp_motion_execution" exec="motion_execution_server">
    <param name="follow_joint_trajectory_action" value="$(var follow_joint_trajectory_action)"/>
  </node>

  <group unless="$(var sim_robot)">
    <!-- [[Motoman Driver Goes Here]] -->
  </group>
  <group if="$(var sim_robot)">
    <node pkg="snp_motion_execution" exec="robot_enable_simulator" />
    <group if="$(var bypass_execution)">
      <node pkg="snp_motion_execution" exec="execution_simulator" >
        <param name="follow_joint_trajectory_action" value="$(var follow_joint_trajectory_action)"/>
      </node>
    </group>
    <group unless="$(var bypass_execution)">
      <include file="$(find-pkg-share snp_motion_execution)/launch/ros2_control.launch.py">
        <arg name="robot_description_file" value="$(var robot_description_file)"/>
        <arg name="controllers_file" value="$(find-pkg-share snp_automate_2022)/config/controllers.yaml"/>
      </include>
    </group>
  </group>
</launch>


